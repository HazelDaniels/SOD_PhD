---
title: "Eradication Effectiveness Binary"
author: "Hazel Daniels"
date: "15 Jan 2021"
output:
  word_document: default
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(tidyr)
library(tibble)
library(ggplot2)
library(vegan)
library(ape)
library(dplyr)
library(viridis)
library(jtools)

SODSites <- read_xlsx("BasicData.xlsx", 1)
head(SODSites)
SODSites <- column_to_rownames(SODSites, var = "New Site")
SODSites$VegBin <- as.numeric(as.character(SODSites$VegBin))
SODSites$SoilBin <- as.numeric(as.character(SODSites$SoilBin))
SODSites$TrtBin <- as.numeric(as.character(SODSites$TrtBin))
SODSites$WFBin <- as.numeric(as.character(SODSites$WFBin))
head(SODSites)
AllSites <- subset(SODSites, SODSites$Lineage != "U")
SODSite.ord <- SODSites[-c(31),,drop=F] #removing HD-4331 as it skews results strongly


AllSeeds <- read_xlsx("BasicData.xlsx", 2)
head(AllSeeds)
AllSeeds <- column_to_rownames(AllSeeds, var = "New Site")
has_rownames(AllSeeds)
head(AllSeeds)
AllSeeds <- AllSeeds[-11] #removing CE as it skews results strongly
AllSeeds <- AllSeeds[-c(31),,drop=F] #removing HD-4331 as it skews results strongly

AllTO <- read_xlsx("BasicData.xlsx", 3)
head(AllTO)
AllTO <- column_to_rownames(AllTO, var = "New_Site")
has_rownames(AllTO)
head(AllTO)

AllFire <- read_xlsx("BasicData.xlsx", 4)
head(AllFire)
AllFire <- column_to_rownames(AllFire, var = "New Site")
has_rownames(AllFire)
head(AllFire)
```

#Visualizing raw site data
```{r}
ggplot(AllSites, aes(x=x)) +
  geom_histogram( aes(x = VegBin, y = stat(count))) +
  scale_x_continuous(name = "Was P.ramorum found in residual Veg sample?", breaks = seq(0, 1)) +
  facet_grid(Lineage ~ TrtBin) +
  labs(title = "Veg") +
  theme_bw()

ggplot(AllSites, aes(x=x)) +
  geom_histogram( aes(x = SoilBin, y = stat(count))) +
  scale_x_continuous(name = "Was P.ramorum found in residual Soil sample?", breaks = seq(0, 1)) +
  facet_grid(Lineage ~ TrtBin) +
  labs(title = "Soil") +
  theme_bw()

Trt <- c(rep("Untreated", 4), rep("Treated", 4))
Lin <- c("EU1","EU1","NA1","NA1","EU1","EU1","NA1","NA1")
Tis <- c("Vegetation","Soil","Vegetation","Soil","Vegetation","Soil","Vegetation","Soil")
Count <- c(18,8,18,3,8,5,12,5)
df <- data.frame(Trt,Lin,Tis,Count)
df

ggplot(df,aes(x=Tis,y=Count,fill=Lin))+
  geom_bar(stat="identity",position="dodge")+
  scale_fill_discrete(name="Lineage",labels=c("EU1", "NA1"))+
  scale_fill_viridis_d() +
  theme_classic()+
  theme(legend.position="none", text = element_text(size=15))+
  xlab("Source material tested positive for P. ramorum")+
  ylab("Count")+
  ylim(0, 20)+
  geom_text(aes(label = Count), vjust = -0.5)+
  facet_grid(Lin~Trt)

#Raw vegetation data seems to show that, for untreated sites (0 column) many were positive for P.ramorum (both NA1 and EU1). For treated sites (1 column) fewer sites tested positive than negative.

#Raw soil data seems to show that, regardless of treatment, fewer sites tested positive for P.ramorum than negative.
```

# Binomial Vegetation
## Generally
```{r}
#Fitting a binomial model
veg_null = glm(VegBin~1, family = binomial, data=AllSites)
veg_full = glm(VegBin~Lineage * WFBin * TrtBin * SoilBin * YrSinceTrt, family=binomial, data=AllSites)
step(veg_null, scope = list(upper=veg_full), direction="both", test="Chisq", data=AllSites)
#VegBin ~ TrtBin + SoilBin + YrSinceTrt + SoilBin:YrSinceTrt

#Is positive veg predicted by treatment and positive soil? (model from stepwise fit)
LRVeg_Gen <- glm(VegBin ~ TrtBin + SoilBin + YrSinceTrt + SoilBin:YrSinceTrt, family=binomial, data=AllSites)
summary(LRVeg_Gen)
summ(LRVeg_Gen)

1-pchisq(133.85-95.882, 97-93)
```

```{r, results='asis'}
export_summs(LRVeg_Gen, veg_null)
```

## Interpretation
For a given site, any treatment changes the log odds of there being positive vegetation by -2.92.

Intercept = 1 (pos veg on plot). It looks like there's a significant predictive quality for whether a site has been treated as to whether there is positive veg. In other words, a treated site has a negative association with positive veg (is less likely to have positive veg than an untreated site). 

It is plausible that the data emanate from a logistic model that includes these variables. We can reject the null hypothesis that the deviance of the model with these variables is the same as the deviance of the model with only the constant. Given a 1 unit increase in TrtBin, we expect a loss of 2 in VegBin (e.g. when Treatment is applied, we expect positive veg to decrease from "present" to "not present").

chi square 0.0000001137722

## NA1
```{r}
#Subsetting data
NA1Sites <- subset(AllSites, AllSites$Lineage == "NA1")

NAV_null = glm(VegBin~1, family = binomial, data=NA1Sites)
NAV_full = glm(VegBin~WFBin * TrtBin * SoilBin * YrSinceTrt, family=binomial, data=NA1Sites)
step(NAV_null, scope = list(upper=NAV_full), direction="both", test="Chisq", data=NA1Sites)
#VegBin ~ SoilBin + TrtBin + YrSinceTrt

#Is NA1 Positive veg predicted by treatment and positive soil? (model from stepwise fit)
LRVeg_NA1 <- glm(VegBin ~ SoilBin + TrtBin + YrSinceTrt, family=binomial, data=NA1Sites)
summary(LRVeg_NA1)
summ(LRVeg_NA1, exp = TRUE)

1-pchisq(70.852-49.223, 51-48)
```

```{r, results='asis'}
export_summs(LRVeg_NA1, NAV_null, scale = TRUE)
```
## Interpretation
For a given NA1 site, any treatment changes the log odds of there being positive vegetation by -3.11.

Intercept = 1 (as in, yes there's pos veg on plot), it looks like there's a significant predictive quality for whether a site has been treated as to whether there is positive veg. In other words, a treated site has a negative association with positive veg (is less likely to have positive veg than an untreated site). 

It is plausible that the data emanate from a logistic model that includes these variables. We can reject the null hypothesis that the deviance of the model with these variables is the same as the deviance of the model with only the constant.

chi square 0.0000779153

## EU1
```{r}
#Subsetting data
EU1Sites <- subset(AllSites, AllSites$Lineage == "EU1")

EUV_null = glm(VegBin~1, family = binomial, data=EU1Sites)
EUV_full = glm(VegBin~WFBin * TrtBin * SoilBin * YrSinceTrt, family=binomial, data=EU1Sites)
step(EUV_null, scope = list(upper=EUV_full), direction="both", test="Chisq", data=EU1Sites)
#VegBin ~ TrtBin + SoilBin

#Is EU1 Positive veg predicted by treatment and positive soil? (model from stepwise fit)
LRVeg_EU1 <- glm(VegBin ~ TrtBin + SoilBin, family=binomial, data=EU1Sites)
summary(LRVeg_EU1)
summ(LRVeg_EU1, exp = TRUE)

1-pchisq(62.985-46.436, 45-43)
```

```{r, results='asis'}
export_summs(LRVeg_EU1, EUV_null, scale = TRUE)
```

## Interpretation
For a given EU1 site, any treatment changes the log odds of there being positive vegetation by -2.2. The presence of positive soil changes the log odds of there being positive vegetation by 1.89.

Intercept = 1 (as in, yes there's pos veg on plot), it looks like there's a significant predictive quality for whether a site has been treated as to whether there is positive veg. In other words, a treated site has a negative association with positive veg (is less likely to have positive veg than an untreated site). 

It is plausible that the data emanate from a logistic model that includes these variables. We can reject the null hypothesis that the deviance of the model with these variables is the same as the deviance of the model with only the constant.

chi square 0.0002549355

# Binomial Soil
## Generally
```{r}
soil_null = glm(SoilBin~1, family = binomial, data=AllSites)
soil_full = glm(SoilBin~WFBin * Lineage * TrtBin * VegBin * YrSinceTrt, family=binomial, data=AllSites)
step(soil_null, scope = list(upper=soil_full), direction="both", test="Chisq", data=AllSites)
#SoilBin ~ VegBin + Lineage + WFBin + VegBin:Lineage

#Is positive soil predicted by positive veg, lineage, wildfire? (model from stepwise fit)
LRSoil_Gen <- glm(SoilBin ~ VegBin + Lineage + WFBin + VegBin:Lineage, family=binomial, data=AllSites)
summary(LRSoil_Gen)
summ(LRSoil_Gen, exp = TRUE)

1-pchisq(101.838-80.179, 97-93)
```

```{r, results='asis'}
export_summs(LRSoil_Gen, soil_null, scale = TRUE)
```
## Interpretation
For a given site, the presence of positive vegetation changes the log odds of there being positive soil by 1.89.

Intercept = 1 (as in, yes there's pos soil on plot), it looks like there's a significant predictive quality for whether a site has positive veg as to whether there is positive soil. In other words, a site with positive veg is more likely to have positive soil than a site without positive veg. 

It is plausible that the data emanate from a logistic model that includes these variables. We can reject the null hypothesis that the deviance of the model with these variables is the same as the deviance of the model with only the constant.

chi square 0.0002343011

## NA1
```{r}
NAS_null = glm(SoilBin~1, family = binomial, data=NA1Sites)
NAS_full = glm(SoilBin~WFBin * TrtBin * VegBin * YrSinceTrt, family=binomial, data=NA1Sites)
step(NAS_null, scope = list(upper=NAS_full), direction="both", test="Chisq", data=NA1Sites)
#SoilBin ~ VegBin + WFBin

#Is NA1 Positive soil predicted by positive veg and wildfire? (model from stepwise fit)
LRSoil_NA1 <- glm(SoilBin ~ VegBin + WFBin, family=binomial, data=NA1Sites)
summary(LRSoil_NA1)
summ(LRSoil_NA1, exp = TRUE)

1-pchisq(44.650-31.75, 51-49)
```

```{r, results='asis'}
export_summs(LRSoil_NA1, NAS_null, scale = TRUE)
```
## Interpretation
For a given NA1 site, there are no factors with a predictive quality, but at the same time, the model selected is the most appropriate one.

It is plausible that the data emanate from a logistic model that includes these variables. We can reject the null hypothesis that the deviance of the model with these variables is the same as the deviance of the model with only the constant.

chi square 0.001580522

## EU1
```{r}
EUS_null = glm(SoilBin~1, family = binomial, data=EU1Sites)
EUS_full = glm(SoilBin~WFBin * TrtBin * VegBin * YrSinceTrt, family=binomial, data=EU1Sites)
step(EUS_null, scope = list(upper=EUS_full), direction="both", test="Chisq", data=EU1Sites)
#SoilBin ~ VegBin

#Is EU1 Positive soil predicted by positive veg? (model from stepwise fit)
LRSoil_EU1 <- glm(SoilBin ~ VegBin, family=binomial, data=EU1Sites)
summary(LRSoil_EU1)
summ(LRSoil_EU1, exp = TRUE)

1-pchisq(54.777-48.429, 45-44)
```

```{r, results='asis'}
export_summs(LRSoil_EU1, EUS_null, scale = TRUE)
```
## Interpretation
For a given EU1 site, the presence of positive vegetation changes the log odds of there being positive soil by 1.89.

Intercept = 1 (as in, yes there's pos soil on plot), it looks like there's a significant predictive quality for whether a site has positive veg as to whether there is positive soil. In other words, a site with positive veg is more likely to have positive soil than a site without positive veg. 

It is plausible that the data emanate from a logistic model that includes these variables. We can reject the null hypothesis that the deviance of the model with these variables is the same as the deviance of the model with only the constant.

chi square 0.01175137

#Take Away Message
Treatment is predicted to affect (reduce) residual vegegation infected by both NA1 and EU1. In turn, whether or not there is positive veg is predicted to affect whether soil is also found to be positive, though this is speaking generally and not for NA1 specifically. Treatment is predicted to reduce veg, which reduces the likelihood of positive soil.

## Logistic Regression for predicting veg by time since treatment
```{r}
#Is positive veg predicted by time since treatment?
LRVeg_t = glm(VegBin~YrSinceTrt, data=AllSites)
summary(LRVeg_t)

1-pchisq(24.000-23.409, 97-96)

#NA1
LRVeg_tNA1 = glm(VegBin~YrSinceTrt, data=NA1Sites)
summary(LRVeg_tNA1)

1-pchisq(12.692-12.467, 51-50)

#EU1
LRVeg_tEU1 = glm(VegBin~YrSinceTrt, data=EU1Sites)
summary(LRVeg_tEU1)
summ(LRVeg_tEU1, exp = TRUE)

1-pchisq(11.3043-8.9373, 45-44)
```

## Logistic Regression for predicting soil by time since treatment
```{r}
#Is positive veg predicted by time since treatment?
LRSoil_t = glm(SoilBin~YrSinceTrt, data=AllSites)
summary(LRSoil_t)

1-pchisq(16.500-16.439, 97-96)

#NA1
LRSoil_tNA1 = glm(SoilBin~YrSinceTrt, data=NA1Sites)
summary(LRSoil_tNA1)

1-pchisq(6.7692-6.7568, 51-50)

#EU1
LRSoil_tEU1 = glm(SoilBin~YrSinceTrt, data=EU1Sites)
summary(LRSoil_tEU1)

1-pchisq(9.3261-8.9321, 45-44)
```
# Tanoak "density" and Vegetation
## Generally
```{r}
TO_null = glm(VegBin~1, data=AllTO)
TO_full = glm(VegBin~TotalTO * Num_Seedlings * TotalStump, data=AllTO)
step(TO_null, scope = list(upper=TO_full), direction="both", test="Chisq", data=AllTO)
#VegBin ~ TotalStump + Num_Seedlings

#Is positive veg predicted by stumps and seedlings? (model from stepwise fit)
LRVeg_TO <- glm(VegBin ~ TotalStump + Num_Seedlings, data=AllTO)
summary(LRVeg_TO)

1-pchisq(24.640-19.322, 99-97)
```

## NA1
```{r}
NA1TO <- subset(AllTO, AllTO$Lineage == "NA1")

NATO_null = glm(VegBin~1, data=NA1TO)
NATO_full = glm(VegBin~TotalTO * Num_Seedlings * TotalStump, data=NA1TO)
step(NATO_null, scope = list(upper=NATO_full), direction="both", test="Chisq", data=NA1TO)
#VegBin ~ TotalStump

#Is positive NA1 veg predicted by stumps? (model from stepwise fit)
LRVeg_TONA1 <- glm(VegBin ~ TotalStump, data=NA1TO)
summary(LRVeg_TONA1)

1-pchisq(12.6923-9.8652, 51-50)
```

## EU1
```{r}
EU1TO <- subset(AllTO, AllTO$Lineage == "EU1")

EUTO_null = glm(VegBin~1, data=EU1TO)
EUTO_full = glm(VegBin~TotalTO * Num_Seedlings * TotalStump, data=EU1TO)
step(EUTO_null, scope = list(upper=EUTO_full), direction="both", test="Chisq", data=EU1TO)
#VegBin ~ TotalStump

#Is positive NA1 veg predicted by stumps? (model from stepwise fit)
LRVeg_TOEU1 <- glm(VegBin ~ TotalStump, data=EU1TO)
summary(LRVeg_TOEU1)

1-pchisq(11.3043-8.8511, 45-44)
```

## Interpretation
Stumps = treatment, so this reinforces previous conclusions.

# Tanoak "density" and Soil
## Generally
```{r}
TOS_null = glm(SoilBin~1, data=AllTO)
TOS_full = glm(SoilBin~TotalTO * Num_Seedlings * TotalStump, data=AllTO)
step(TOS_null, scope = list(upper=TOS_full), direction="both", test="Chisq", data=AllTO)
#SoilBin ~ TotalStump

#Is positive soil predicted by stumps? (model from stepwise fit)
LRS_TO <- glm(SoilBin ~ TotalStump, data=AllTO)
summary(LRS_TO)

1-pchisq(16.950-15.591, 99-98)
```

## NA1
```{r}
NATOS_null = glm(SoilBin~1, data=NA1TO)
NATOS_full = glm(SoilBin~TotalTO * Num_Seedlings * TotalStump, data=NA1TO)
step(NATOS_null, scope = list(upper=NATOS_full), direction="both", test="Chisq", data=NA1TO)
#SoilBin ~ TotalStump

#Is positive NA1 soil predicted by stumps? (model from stepwise fit)
LRS_TONA1 <- glm(SoilBin ~ TotalStump, data=NA1TO)
summary(LRS_TONA1)

1-pchisq(6.7692-6.3967, 51-50)
```

## EU1
```{r}
EUTOS_null = glm(SoilBin~1, data=EU1TO)
EUTOS_full = glm(SoilBin~TotalTO * Num_Seedlings * TotalStump, data=EU1TO)
step(EUTOS_null, scope = list(upper=EUTOS_full), direction="both", test="Chisq", data=EU1TO)
#SoilBin ~ TotalStump

#Is positive NA1 veg predicted by stumps? (model from stepwise fit)
LRS_TOEU1 <- glm(SoilBin ~ TotalStump, data=EU1TO)
summary(LRS_TOEU1)

1-pchisq(9.3261-8.5309, 45-44)
```

## Interpretation
Stumps = treatment, so this reinforces previous conclusions.

# Are current treatments effectively reducing P. ramorum infections in soil and vegetation?
```{r}
#Setting up data
Veg <- AllSites %>% select(9, 19)

VegTable <- table(Veg$TrtBin, Veg$VegBin)

chisq.test(VegTable)$expected
Veg.f <- fisher.test(VegTable)
Veg.f

Soil <- AllSites %>% select(9, 23)

SoilTable <- table(Soil$TrtBin, Soil$SoilBin)

chisq.test(SoilTable)$expected
Soil.f <- fisher.test(SoilTable)
Soil.f

#For Veg only: We reject the null hypothesis that there is no significant relationship between the two variables (treatment and positive vegetation) using Fisher's exact test.


#For Soil only: We accept the null hypothesis that there is no significant relationship between the two variables (treatment and positive soil) using Fisher's exact test.
```

# Is wildfire better than current treatments at removing P. ramorum from sites?
```{r}
#Veg
Firev_full = glm(VegBin~WFBin * TrtBin, family=binomial, data=AllFire)
summary(Firev_full)

1-pchisq(137.19-114.40, 99-96)

#Soil
Fires_full = glm(SoilBin~WFBin * TrtBin, family=binomial, data=AllFire)
summary(Fires_full)

1-pchisq(102.791-94.585, 99-96)
```

# Ordination of seedling data
## NMDS
```{r}
PCASeeds <- AllSeeds[5:35]
DistSeed <- vegdist(PCASeeds, method = "bray")

NMDS.scree <- function(x) { #where x is the name of the data frame variable
  plot(rep(1, 10), replicate(10, metaMDS(x, autotransform = F, k = 1)$stress), xlim = c(1, 10),ylim = c(0, 0.30), xlab = "# of Dimensions", ylab = "Stress", main = "NMDS stress plot")
  for (i in 1:10) {
    points(rep(i + 1,10),replicate(10, metaMDS(x, autotransform = F, k = i + 1)$stress))
  }
}

#NMDS.scrree(DistSeed) chunk excluded to save space
```

```{r, include=FALSE}
NMDS.scree(DistSeed)
```

```{r}
NMDS1 <- metaMDS(DistSeed, k = 2, trymax = 100, trace = F)
NMDS1
Stress <- stressplot(NMDS1)
Stressplot <- plot(NMDS1, type = "t")

NMDS2 <- metaMDS(PCASeeds, k = 2, trymax = 100, trace = F)
NMDS2

NMDS3 <- metaMDS(PCASeeds, k = 2, trymax = 100, trace = F, autotransform = FALSE, distance="bray")
NMDS3plot <- plot(NMDS3)
NMDS3plotsp <- plot(NMDS3, display = "species")
```

## Interpretation (including effects variables)
```{r}
#Interpretation
EFSites <- select(SODSite.ord, 3, 8:11, 19, 23, 26)

ef <- envfit(NMDS3, EFSites, permutations = 999, na.rm = TRUE)
ef

efplot <- plot(NMDS3, type = "t", display = "species")
efplot2 <- plot(ef, p.max = 0.05)
efplot2
```

## Interpretation by treatment
```{r}
group = c(rep("Untreated", 56), rep("Treated", 43))
colors = c(rep("red", 56), rep("blue", 43))

ordiplot(NMDS3, type = "n")
for(i in unique(group)) {
  ordihull(NMDS3$point[grep(i, group),], draw="polygon",
  groups = group[group == i],col = colors[grep(i,group)],label=F) }

orditorp(NMDS3, display = "species", col = "red", air = 0.01)
#orditorp(NMDS3, display = "sites", col = c(rep("red",12),
#  rep("blue", 12)), air = 0.01, cex = 1.25)
```

```{r}
MRPP <- mrpp(PCASeeds, EFSites, permutations = 999, distance = "bray", weight.type = 1, strata = NULL, parallel = getOption("mc.cores"))
summary(MRPP)
```